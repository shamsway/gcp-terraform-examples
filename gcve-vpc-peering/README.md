This example Terraform code will create a VPC network, subnet, and additional configuration that is ready to peer with a Google Cloud VMware Engine (GCVE) environment. To use this example you should have an existing GCVE cluster, and a Terraform environment that is configured to work with your GCP project.

## Objectives

This Terraform code will do the following:

*   Create a VPC network
*   Create a subnet in the new VPC network that will be used to communicate with GCVE
*   Create two Global Address pools that will be used to reserve addresses used in GCVE
*   Create a private connection in the new VPC, using the two address pools as reserved ranges
*   Enable import and export of custom routes for the VPC

After configuration is completed by Terraform, you will be able to complete peering with the new VPC in GCVE. Further information about peering a VPC with GCVE is documented in [Setting up private service access](https://cloud.google.com/vmware-engine/docs/networking/howto-setup-private-service-access).  
## Costs 

This tutorial uses billable components of Google Cloud, including the following:

*   [Google Cloud VMware Engine](https://cloud.google.com/vmware-engine)
*   [VPC](https://cloud.google.com/vpc/pricing)

Use the [pricing calculator](https://cloud.google.com/products/calculator) to generate a cost estimate based on your projected usage.
## Before you begin

This tutorial assumes that you have a basic understanding of Terraform, GCP, and GCVE, and that you have already deployed a GCVE environment.   

## Usage

To use this example, you will need to provide values for several variables, after which you can run Terraform.

### Variables Used

* `project`: The project ID to deploy to
* `region`: The region to use. Default value is `us-west2`.
* `zone`: The zone to use. Default value is `us-west2-a`.
* `network_name`: Name of the VPC network to create.
* `network_descr`: Description for the VPC network to create. Default value is blank.
* `subnet_name`: Name of the subnet to create. 
* `subnet_cidr`: CIDR of the subnet to create.
* `reserved1_name`: Name of first network reserved for GCVE.
* `reserved1_address`: Address of first network reserved for GCVE.
* `reserved1_address_prefix_length`: Prefix length of first network reserved for GCVE.
* `reserved2_name`: Name of second network reserved for GCVE.
* `reserved2_address`: Address of second network reserved for GCVE.
* `reserved2_address_prefix_length`: Prefix length of second network reserved for GCVE.
* `service`: Service value to use in `google_service_networking_connection` resource. Default value is `servicenetworking.googleapis.com`.
* `peering`: Peering value to use in `google_compute_network_peering_routes_config` resource. Default value is `servicenetworking-googleapis-com`.
* `address_purpose`: Purpose value to use in `google_compute_global_address` resource. Default value is `VPC_PEERING`.
* `address_type`: Address type value to use in google_compute_global_address resource. Default value is `INTERNAL`.
### Initialize and Run Terraform

1. Edit `terraform.tfvars` to specify values for the requried variables
2. Run `terraform init` and ensure no errors are displayed
3. Run `terraform plan` and review the changes that Terraform will perform
4. Run `terraform apply` to apply the proposed configuration changes

### View VPC configuration in the Google Cloud Console

Once `terraform apply` completes, you can see the results in the [Google Cloud Console](https://console.cloud.google.com/).

![](/gcve-network/screenshots/network_allocated_ips_edited.png)

IP ranges reserved for use in GCVE are reserved.

![](/gcve-network/screenshots/network_service_connection_edited.png)

Private service access is configured.

![](/gcve-network/screenshots/network_peering_edited.png)

Import and export of custom routes on the `servicenetworking-googleapis-com` private connection is enabled.
### Complete Peering in GCVE

The final step is to create the private connection in the VMware Engine portal. You will need the following information to configure the private connection.

* Project ID (found under `Project info` on the console dashboard.) `Project ID` may be different than `Project Name`, so verify you are gathering the correct information.
* Project Number (also found under `Project info` on the console dashboard.)
* Name of the VPC (`network_name` in your `variables.tf` file.)
* Peered project ID from VPC Network Peering screen (pictured above)

Save all of these values somewhere handy, and follow these steps to complete peering
 
![](/gcve-network/screenshots/15b_add_private_connection_edited.png)

1. Open the VMware Engine portal, and browse to `Network > Private connection`.
2. Click `Add network connection` and paste the required values. Supply the peered project ID in the `Tenant project ID` field, VPC name in the `Peer VPC ID` field, and complete the remaining fields.
3. Choose the region your VMware Engine private cloud is deployed in, and click submit.

![](/gcve-network/screenshots/16_add_private_connection_edited.png)

After a few moments, `Region Status` should show a status of `Connected`. Your VMware Engine private cloud is now peered with your Google Cloud VPC. You can verify peering is working by checking the routing table of your VPC.

### Verify VPC Routing Table

* Console
* gcloud tool
## Cleaning up

To remove the resources created by this example, run `terraform destroy` and answer `yes` when prompted to continue. This will only remove the VPC network and related configuration created by Terraform. Your GCVE environment will have to be deleted using [these instructions](https://cloud.google.com/vmware-engine/docs/private-clouds/howto-delete-private-cloud), if desired.

## What's next

Tell the reader what they should read or watch next if they're interested in learning more.

### Example: What's next

- Watch this tutorial's [Google Cloud Level Up episode on YouTube](https://youtu.be/uBzp5xGSZ6o).
- Learn more about [AI on Google Cloud](https://cloud.google.com/solutions/ai/).
- Learn more about [Cloud developer tools](https://cloud.google.com/products/tools).
- Try out other Google Cloud features for yourself. Have a look at our [tutorials](https://cloud.google.com/docs/tutorials).