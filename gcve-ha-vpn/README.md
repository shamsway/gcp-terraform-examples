This example code is a modified and update version of the example provided at https://github.com/GoogleCloudPlatform/community/tree/master/tutorials/deploy-ha-vpn-with-terraform/terraform. Using this example will create the minimum configuration needed to stand up a VPN to GCP/GCVE. It is assumed that you have already created a VPC and configured peering with your GCVE cluster (https://networkbrouhaha.com/2021/02/gcp-vpc-to-gcve/). This example does not actually create a redundant VPN solution, but it can be easily extended to do so by creating a secondary Cloud Router, interface and BGP peer.

You can find more information about this example here: http://networkbrouhaha.com/2021/05/gcve-networking-notes/
# Objectives

This Terraform code will do the following:

* Create a VPN Gateway, External Gateway, Cloud Router, VPN tunnel and related configuration for an IPSec connection to GCP/GCVE

# Costs 

This tutorial uses billable components of Google Cloud, including the following:

* [Google Cloud VMware Engine](https://cloud.google.com/vmware-engine)
* [VPC](https://cloud.google.com/vpc/pricing)
* [Cloud VPN](https://cloud.google.com/network-connectivity/docs/vpn/pricing)

Use the [pricing calculator](https://cloud.google.com/products/calculator) to generate a cost estimate based on your projected usage.

# Before you begin

This tutorial assumes that you have a basic understanding of Terraform, GCP, and GCVE. It is also assumed that that you have already deployed a GCVE environment and a peered VPC. This example code will only deploy the GCP-related components needed for a VPN. You will be responsible for configuring the VPN components at your site.

# Usage

To use this example, you will need to provide values for a few variables, and you will need to update `main.tf` with accurate values for your environment. You can provide these variables by specifying them in the `terraform.tfvars` file, or by using environment variables. Ensure you have updated the `advertised_ip_ranges` in the `google_compute_router.vpn-cr` resource to match the ranges in your GCVE environment that you want to access over VPN.

## Variables Used

* `project`: GCP Project ID to use
* `region`: The primary region to use
* `zone`: The primary zone to use
* `network_name`: Name of the VPC network to use
* `subnet_name`: Name of the subnet to use. This subnet will be advertised across the VPN.
* `ha_vpn_gateway`: Name of the HA VPN gateway to create
* `cloud_router`: Name of the Cloud Router to create
* `router_int0`: Cloud Router interface name
* `router_int_ip_0`: IP and subnet (CIDR format) for the Cloud Router interface used for BGP peering
* `bgp_peer_0`: Name for the BGP peering relationship
* `gcp_asn`: BGP Autonoumous System Number for GCP Cloud Router
* `peer_asn`: BGP Autonoumous System Number for customer site
* `peer_ip`: IP at the customer site used for BGP peering
* `peer_gw_name`: Peer Gateway name
* `peer_gw`: IP at the customer site used for IPSec VPN peering
* `tunnel_name`: VPN tunnel name
* `shared_secret`: VPN shared secret

### Using Envrironment Variables

You can use the following commands on MacOS or Linux to provide the `shared_secret` value via environment variable. This is a good practice when passing sensitive data to Terraform.

```bash
export TF_VAR_shared_secret='01234567890abcdefABCDEF'
```

You can use the `unset` commmand to remove set environment variables, if necessary.

## Initialize and Run Terraform

Once your variables are set, and you have modified the values in `main.tf` to match your environment, follow the steps below to initialize and run Terraform.

1. Run `terraform init` and ensure no errors are displayed
2. Run `terraform plan` and review the changes that Terraform will perform
3. Run `terraform apply` to apply the proposed configuration changes

## Cleaning up

To remove the resources created by this example, run `terraform destroy` and answer `yes` when prompted to continue. This will only remove IPSec VPN and related configuration in GCP created by Terraform. Your GCVE environment will have to be deleted using [these instructions](https://cloud.google.com/vmware-engine/docs/private-clouds/howto-delete-private-cloud), if desired.

# Helpful Links

* [Deploy HA VPN with Terraform](https://cloud.google.com/community/tutorials/deploy-ha-vpn-with-terraform)
* [Cloud VPN topologies](https://cloud.google.com/network-connectivity/docs/vpn/concepts/topologies)
* [Using third-party VPNs with Cloud VPN](https://cloud.google.com/network-connectivity/docs/vpn/how-to/interop-guides)
* [google_compute_network Data Source](https://registry.terraform.io/providers/hashicorp/google/latest/docs/data-sources/compute_network)
* [google_compute_subnetwork Data Source](https://registry.terraform.io/providers/hashicorp/google/latest/docs/data-sources/compute_subnetwork)
* [google_compute_ha_vpn_gateway Resource](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_ha_vpn_gateway)
* [google_compute_router Resource](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_router)
* [google_compute_external_vpn_gateway Resource](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_external_vpn_gateway)
* [google_compute_vpn_tunnel Resource](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_vpn_tunnel)
* [google_compute_router_interface Resource](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_router_interface)
* [google_compute_router_peer Resource](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_router_interface)