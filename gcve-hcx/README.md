
This example Terraform code will use a community provider, [adeleporte/hcx](https://registry.terraform.io/providers/adeleporte/hcx/), to configure an HCX site pairing, service mesh, and related components between an on-prem data center and a Google Cloud VMware Engine (GCVE) SDDC. To use this example you should have an existing GCVE cluster, and a Terraform environment that is configured to work with your GCP project, and HCX installed on-prem.

You can find more information about this example here: [http://networkbrouhaha.com/2021/04/gcve-hcx-config/](http://networkbrouhaha.com/2021/04/gcve-hcx-config/)

# Objectives

This Terraform code will do the following:

* Create a Site Pairing in HCX between your on-prem data center and your GCVE SDDC
* Create Network Profiles for management and vMotion networks
* Create a Compute Profile
* Create a Service Mesh using the Site Pairing, Network Profiles, and Compute Profiles
* Extend a network from on-prem to GCVE using HCX Network Extension

After configuration is completed by Terraform, you will be able to use HCX to migrate Virtual Machines from your on-prem data center to GCVE. You can use [PowerCLI](https://developer.vmware.com/powercli) or the HCX API to automate VM migrations.

# Costs 

This tutorial uses billable components of Google Cloud, including the following:

* [Google Cloud VMware Engine](https://cloud.google.com/vmware-engine)
* [VPC](https://cloud.google.com/vpc/pricing)

Use the [pricing calculator](https://cloud.google.com/products/calculator) to generate a cost estimate based on your projected usage.

# Before you begin

This tutorial assumes that you have a basic understanding of Terraform, GCP, and GCVE, and that you have already deployed a GCVE environment.   

# Usage

To use this example, you will need to provide values for a few variables, and you will need to update `main.tf` with accurate values for your environment.

## Variables Used

* `hcx_admin_username`: Username for on-prem HCX appliance management. Default value is `admin`.
* `hcx_admin_password`: Password for on-prem HCX appliance management
* `hcx_username`: Username for on-prem HCX instance
* `hcx_password`: Password for on-prem HCX instance
* `gcve_hcx_username`: Username for GCVE HCX instance. Default value is `CloudOwner@gve.local`
* `gcve_hcx_password`: Password for GCVE HCX instance

### Using Envrironment Variables

You can use the following commands on MacOS or Linux to provide these variable values via environment variables. This is a good practice when passing credentials to Terraform.

```bash
export TF_VAR_hcx_admin_username='admin'
export TF_VAR_hcx_admin_password='password'
export TF_VAR_hcx_username='hcxuser@yourcompany.biz'
export TF_VAR_hcx_password='password'
export TF_VAR_gcve_hcx_username='CloudOwner@gve.local'
export TF_VAR_gcve_hcx_password='password'
```

You can use the `unset` commmand to remove set environment variables, if necessary.

## Initialize and Run Terraform

Once your variables are set, and you have modified the values in `main.tf` to match your environment, follow the steps below to initialize and run Terraform.

1. Run `terraform init` and ensure no errors are displayed
2. Run `terraform plan` and review the changes that Terraform will perform
3. Run `terraform apply` to apply the proposed configuration changes

## Cleaning up

To remove the resources created by this example, run `terraform destroy` and answer `yes` when prompted to continue. This will only remove the service mesh and related configuration created by Terraform. Your GCVE environment will have to be deleted using [these instructions](https://cloud.google.com/vmware-engine/docs/private-clouds/howto-delete-private-cloud), if desired.

# Caveats

This example is based on a community Terraform provider, and is not officially support by VMware. This provider is under active development and it is possible that you may hit a bug. Think carefully before using any content in this example in an enterprise environment before performing extensive testing. If you do hit a bug, or would like to contribute code to this provider, cruise over to the [GitHub repo](https://github.com/adeleporte/terraform-provider-hcx).

# Helpful Links

* [Migrating VMware VMs using VMware HCX](https://cloud.google.com/vmware-engine/docs/workloads/howto-migrate-vms-using-hcx)
* [adeleporte/hcx](https://registry.terraform.io/providers/adeleporte/hcx/) community Terraform provider for HCX
* [hcx_site_pairing Resource](https://registry.terraform.io/providers/adeleporte/hcx/latest/docs/resources/site_pairing)
* [hcx_network_profile Resource](https://registry.terraform.io/providers/adeleporte/hcx/latest/docs/resources/network_profile)
* [hcx_compute_profile Resource](https://registry.terraform.io/providers/adeleporte/hcx/latest/docs/resources/compute_profile)
* [hcx_service_mesh Resource](https://registry.terraform.io/providers/adeleporte/hcx/latest/docs/resources/service_mesh)
* [hcx_l2_extension Resource](https://registry.terraform.io/providers/adeleporte/hcx/latest/docs/resources/l2_extension)