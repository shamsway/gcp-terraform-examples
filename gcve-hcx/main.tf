terraform {
  required_providers {
    hcx = {
      source = "adeleporte/hcx"
    }
  }
}

provider "hcx" {
  hcx = "https://your.hcx.url"

  admin_username = var.hcx_admin_username
  admin_password = var.hcx_admin_password

  username = var.hcx_username
  password = var.hcx_password
}

resource "hcx_site_pairing" "gcve" {
  url      = "https://gcve.hcx.url"
  username = var.gcve_hcx_username
  password = var.gcve_hcx_password
}

resource "hcx_network_profile" "net_management_gcve" {
  site_pairing = hcx_site_pairing.gcve
  network_name = "Management network name"
  name         = "Management network profile name"
  mtu          = 1500

  ip_range {
    start_address = "172.17.10.10"
    end_address   = "172.17.10.13"
  }

  gateway       = "172.17.10.1"
  prefix_length = 24
  primary_dns   = "172.17.10.2"
  secondary_dns = "172.17.10.3"
  dns_suffix    = "yourcompany.biz"
}

resource "hcx_network_profile" "net_vmotion_gcve" {
  site_pairing = hcx_site_pairing.gcve
  network_name = "vMotion network name"
  name         = "vMotion network profile name"
  mtu          = 1500

  ip_range {
    start_address = "172.17.11.10"
    end_address   = "172.17.11.13"
  }

  gateway       = "172.17.11.1"
  prefix_length = 24
  primary_dns   = "172.17.11.2"
  secondary_dns = "172.17.11.3"
  dns_suffix    = "yourcompany.biz"
}

resource "hcx_compute_profile" "compute_profile_1" {
  name       = "SJC-CP"
  datacenter = "San Jose"
  cluster    = "Compute Cluster"
  datastore  = "comp-vsanDatastore"
  depends_on = [
    hcx_network_profile.net_management_gcve, hcx_network_profile.net_vmotion_gcve
  ]

  management_network  = hcx_network_profile.net_management_gcve.id
  replication_network = hcx_network_profile.net_management_gcve.id
  uplink_network      = hcx_network_profile.net_management_gcve.id
  vmotion_network     = hcx_network_profile.net_vmotion_gcve.id
  // This parameter should be "network_container" instead of "dvs". You can specify a DVS or NSX Transport Zone depending on your environment.
  dvs                 = "nsx-overlay-transportzone"

  service {
    name = "INTERCONNECT"
  }

  service {
    name = "WANOPT"
  }

  service {
    name = "VMOTION"
  }

  service {
    name = "BULK_MIGRATION"
  }

  service {
    name = "NETWORK_EXTENSION"
  }

}

resource "hcx_service_mesh" "service_mesh_1" {
  name                   = "Service Mesh Name"
  site_pairing           = hcx_site_pairing.gcve
  local_compute_profile  = hcx_compute_profile.compute_profile_1.name
  remote_compute_profile = "GCVE Compute Profile"
  depends_on = [ hcx_compute_profile.compute_profile_1 ]

  app_path_resiliency_enabled   = false
  tcp_flow_conditioning_enabled = false

  uplink_max_bandwidth = 10000

  service {
    name = "INTERCONNECT"
  }

  service {
    name = "WANOPT"
  }

  service {
    name = "VMOTION"
  }

  service {
    name = "BULK_MIGRATION"
  }

  service {
    name = "NETWORK_EXTENSION"
  }

}

resource "hcx_l2_extension" "l2_extension_1" {
  site_pairing    = hcx_site_pairing.gcve
  service_mesh_id = hcx_service_mesh.service_mesh_1.id
  source_network  = "Name of local network to extend"
  network_type    = "NsxtSegment"
  depends_on = [ hcx_service_mesh.service_mesh_1 ]

  destination_t1 = "Tier1"
  gateway        = "192.168.10.1"
  netmask        = "255.255.255.0"

}